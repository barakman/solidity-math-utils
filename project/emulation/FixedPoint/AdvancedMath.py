from .common.BuiltIn import *
from . import AnalyticMath
from . import FractionMath
from . import IntegralMath

SCALE_1 = AnalyticMath.SCALE_1;
FIXED_1 = AnalyticMath.FIXED_1;

# Auto-generated via 'PrintAdvancedMathConstants.py'
LAMBERT_NEG1_MAXVAL = 0x002e9e207581ee21a2fdc7e0328c907634;
LAMBERT_NEG2_MAXVAL = 0x002f16ac6c59de6f8d5d6f63c1482a7c86;
LAMBERT_NEG2_SAMPLE = 0x0000080954b9100531c21c3bf872e8228e;
LAMBERT_NEG2_T_SIZE = 0x0000000000000000000000000000000011;
LAMBERT_NEG2_T_MASK = 0xffffffffffffffffffffffffffffffffff;
LAMBERT_POS1_MAXVAL = 0x002f16ac6c59de6f8d5d6f63c1482a7c86;
LAMBERT_POS2_MAXVAL = 0x0c2f16ac6c59de6f8d5d6f63c1482a7c56;
LAMBERT_POS2_SAMPLE = 0x00183060c183060c183060c183060c1830;
LAMBERT_POS2_T_SIZE = 0x0000000000000000000000000000000010;
LAMBERT_POS2_T_MASK = 0x00ffffffffffffffffffffffffffffffff;
LAMBERT_NEG2_VALUES = "012ff3f5b94a776318e70a4b0be31da9a5"\
                      "01314a4702ae8ae09a01a03f6933dcf01f"\
                      "0132afb4b8985b32518cd371f2b5c6de56"\
                      "0134260eac628aa55b0b35bd5ba1df0e6e"\
                      "0135af881e5cbc17f5de16bb05816826c0"\
                      "01374ed8520d0404e91fe8e683b8d8173e"\
                      "0139076a4780adf3619a57f1b6e40e3f20"\
                      "013adda534e8e43471fe0ae32b8bbf0cfc"\
                      "013cd75f834551aa105eff810be8afd15e"\
                      "013efc9f6e12358e1f8c040050efadd3e2"\
                      "014158f4e68e9217def733dc63fba7eba9"\
                      "0143fe22b87c9944205ebc3be59f410691"\
                      "01470a158303eabda73222305243e7c7b2"\
                      "014ab733a071f0dfc80ab6c42b29b5ce07"\
                      "014f9c668b59483575a0daad8006952948"\
                      "015aa59d425cbd5ed5a6a64da5a1108555";
LAMBERT_POS2_VALUES = "60e393c68d20b1bd09deaabc0373b9c5"\
                      "577b97aa1fe222bb452fdf111b1f0be2"\
                      "5035f241d6eae0cd7bacba119993de7b"\
                      "4a5cbc96a05589cb4d86be1db3168364"\
                      "4585c8b3f8fe489c6e1833ca47871384"\
                      "416e1b785d13eba07a08f3f18876a5ab"\
                      "3de8f65ac388101ddf718a6f5c1eff65"\
                      "3ad71c1c77e34fa32a9f184967eccbf6"\
                      "3821f57dbd2763256c1a99bbd2051378"\
                      "35b8b28d1a73dc27500ffe35559cc028"\
                      "338e82ce00e2496262c64457535ba1a1"\
                      "31996ec6b07b4a83421b5ebc4ab4e1f1"\
                      "2fd19346ed17dac61219ce0c2c5ac4b0"\
                      "2e309a221c12ba361e3ed695167feee2"\
                      "2cb15ad3a1eb65f6d74a75da09a1b6c5"\
                      "2b4f95cd46904d05d72bdcde337d9cc7"\
                      "2a07c206cde2c9467e42ebdfc395e285"\
                      "28d6e752efcbae881bb2163e088236de"\
                      "27ba81d008f57136440e87f44fb95f59"\
                      "26b06bf4b3ca8a8e6b5f1207cf63e484"\
                      "25b6cd7b40b306b014cc93eb0fd34b1b"\
                      "24cc0df118d221d961d0e3c7c2cc74d8"\
                      "23eeca079ec9f001c7488cb0210969d3"\
                      "231dcb016e2797ddce1ba75a69081655"\
                      "2257ffc1f84048f54f9072007f255977"\
                      "219c772441c4b78d49d6bf72dea3ab56"\
                      "20ea5b53c3a2de83f69655808913322d"\
                      "2040edf2ba98675afaf33ad7b36a7956"\
                      "1f9f84e53efd744e8c01d02e4f1071c8"\
                      "1f0587a1831d516e4979ad85cd0b3e5a"\
                      "1e726cec66b24906997bda3801535ebd"\
                      "1de5b8eebff06b21b543b19c5fa002d9"\
                      "1d5efb93b9235c7a64079fab2ad709ba"\
                      "1cddcf23ba8eb156b9b26750904cf312"\
                      "1c61d711c357ed86ebefbfee82d3264a"\
                      "1beabef2fb396b13011f8ea801422ad9"\
                      "1b783999c85b7cd9ce638b020080d100"\
                      "1b0a004ee7fd8c81ac47b6c04894bb04"\
                      "1a9fd223fef4735d6e1130db2341072b"\
                      "1a39735bdda3a6d7e2b3d1dd5d800661"\
                      "19d6ace55419021d7827019f435c30c5"\
                      "19774be5f6227a7ba0b2e9c5d78c13c8"\
                      "191b21529a9dc854272046bfe7592441"\
                      "18c20193b99c0f235d36b322031296a9"\
                      "186bc43415f31f813caf1fb4300e23c9"\
                      "181843985b6794d75c8c626a51041977"\
                      "17c75cbe8d10c6063ecfe590c8a0fd84"\
                      "1778ef0449cafac4a5cf259d93863693"\
                      "172cdbf30ff93902a95a8146b585c655"\
                      "16e30711c7afebcb40109634b86d8799"\
                      "169b55baf39bccd230485248f4995e18"\
                      "1655aef6fe5d98ce041a10e7ca963ad3"\
                      "1611fb5a2c46df8f23786225867f6d08"\
                      "15d024e5c8ecb766b45e74cdc8172794"\
                      "159016ec3550613e36a46d481b57d4a2"\
                      "1551bdf786c6d4b006e447ee93fe60bf"\
                      "151507b27099e70da8f1197ca7a94b1e"\
                      "14d9e2d33ad6bc2f8f1e6a949032aae3"\
                      "14a03f0890117064244d99699b33162a"\
                      "14680ce7f240e96bd25479e66a1a1872"\
                      "14313dddac5beb6ae0dc9ab15e6325a4"\
                      "13fbc41e1b3092ef02d998374545ec41"\
                      "13c792982c23053712ec80994a00d48b"\
                      "13949ce8f42d5c83b87967913b857db2"\
                      "1362d75044b414864af094d1c98c5045"\
                      "133236a6269740b8ed72a7216b473521"\
                      "1302b05126670d0c809cfdf596bf59aa"\
                      "12d43a3d5ed4e587f9bf9f3546a14cc9"\
                      "12a6cad4306bf1e228555efcf9e981b3"\
                      "127a58f49753c126c34fccd0fb33a40a"\
                      "124edbec11664bc999baaffb949ae84c"\
                      "12244b70083d14d53392cc3d4aec745c"\
                      "11fa9f97b40d9011194c94a270e6c582"\
                      "11d1d0d66d3fb456945cf53f8cddd542"\
                      "11a9d7f6639ed17b5ab53f819bad9299"\
                      "1182ae13b2dfe31bd4041aed11d1bc02"\
                      "115c4c97ccfcbb784459d0fc547c65dc"\
                      "1136ad3533932db11c651bec0f863f9f"\
                      "1111c9e37a1528d2e3a11bbe1671030d"\
                      "10ed9cdb8b2486b23f5197f432dfedde"\
                      "10ca20942bf4f38da855bc16829f7176"\
                      "10a74fbeb90156f2ef7da0e6ff154ef2"\
                      "1085254417c9ec4689192684fd24d9fb"\
                      "10639c41d9adf82e9a962729d9c5354b"\
                      "1042b0078c48d2121c45356ef952a884"\
                      "10225c143406bfe3646184b22ff0b242"\
                      "10029c13edebbcadcd02f4bf6077e934"\
                      "0fe36bddb5c56d8889ed2aa2164563dd"\
                      "0fc4c7714e3aeceb64a83c0fbd5b3409"\
                      "0fa6aaf54861476764473f34e82d3a9c"\
                      "0f8912b528ab0b6a790407fa5f9bf8b1"\
                      "0f6bfb1fa7349e64712ab860554d7b78"\
                      "0f4f60c509968df5add12deae5027309"\
                      "0f334055948b2a0dc667a844c6723b23"\
                      "0f1796a013d5b15214dc09abf2a0592b"\
                      "0efc609076f78738f15c360223f8c79d"\
                      "0ee19b2e815b8e957ce06c5e16449ca8"\
                      "0ec7439c8cb9187b324eb1d2758ee4d3"\
                      "0ead57165c8714db919b9ccd15e45159"\
                      "0e93d2f0016d88ff1e5182897a357740"\
                      "0e7ab494cbb6ec0c4cbc602eb4bb78e3"\
                      "0e61f9864bd512e429ac81729beeec69"\
                      "0e499f5b601dee819305eb00790b9c9a"\
                      "0e31a3bf4ef3ab0dadc11b18d962c820"\
                      "0e1a0470ec99d736c6436de2abaf3b64"\
                      "0e02bf41cc063d700f4cb7817df3dfd7"\
                      "0debd2157a081b83117c46ea1dc579d1"\
                      "0dd53ae0c22b7df344fa51532b60dd98"\
                      "0dbef7a8fcc8c7c9c5332ac339c9f88d"\
                      "0da9068365b9ee4b304fb9666adccf46"\
                      "0d9365947b37bb14237ee7d1802ffa2f"\
                      "0d7e130f64698ce1098c56ddad89fb56"\
                      "0d690d355f399d48cad4f9225f1a3f9d"\
                      "0d5452553506d42a1f2f7d5cf97679d9"\
                      "0d3fe0cab5d3b39f329597f217bf7928"\
                      "0d2bb6fe3997f32783f2b5d8a3acd0c9"\
                      "0d17d364275fffa6cb83e0553ca42663"\
                      "0d04347c81ead056e793c81ed9aa583e"\
                      "0cf0d8d2797b5e9e40afe04977971655"\
                      "0cddbefc029796ff51a1c94f6c2e5589"\
                      "0ccae5997172d28b9d7969676b6cfb06"\
                      "0cb84b5519c5d86400e5ebbcb895c475"\
                      "0ca5eee2f2da13533492e3978c84b997"\
                      "0c93cf003f91157bbee2579fcf0a33f3"\
                      "0c81ea733a34b805f2bf6edd83fca2cd"\
                      "0c70400ac3df22f2e73d2a54bee3b3ee"\
                      "0c5ece9e174cd59d6c32f900259dd921"\
                      "0c4d950c7eed66993aa3f25a85ea9e43";
LAMBERT_EXACT_LIMIT = 0x001abb58194f861a372fc4a5e2a64806c77ee7849dd0a347ea7ddf2ba582711b;

'''
    @dev Solve x * (a / b) ^ x = c / d
    Solution: x = W(log(a / b) * c / d) / (log(a / b) * c / d) * c / d
'''
def solveExact(a, b, c, d):
    return solve(a, b, c, d, lambertNegExact, lambertPosExact);

'''
    @dev Solve x * (a / b) ^ x = c / d
    Solution: x = W(log(a / b) * c / d) / (log(a / b) * c / d) * c / d
'''
def solveQuick(a, b, c, d):
    return solve(a, b, c, d, lambertNegQuick, lambertPosQuick);

'''
    @dev Compute W(-x / FIXED_1) / (-x / FIXED_1) * FIXED_1
    Input range: 1 <= x <= LAMBERT_NEG2_MAXVAL
'''
def lambertNegExact(x):
    require(x > 0, "lambertNegExact: x < min");
    if (x <= LAMBERT_NEG2_MAXVAL):
        y = x;
        for i in range(8):
            e = AnalyticMath.fixedExp(y);
            y = (x * e - y * y) // (FIXED_1 - y);
        return IntegralMath.mulDivF(FIXED_1, y, x);
    revert("lambertNegExact: x > max");

'''
    @dev Compute W(x / FIXED_1) / (x / FIXED_1) * FIXED_1
    Input range: 1 <= x <= 2 ^ 256 - 1
'''
def lambertPosExact(x):
    require(x > 0, "lambertPosExact: x < min");
    if (x <= LAMBERT_EXACT_LIMIT):
        if (x < FIXED_1):
            p = AnalyticMath.fixedExp(x);
            q = IntegralMath.mulShrF(x, p, SCALE_1);
            y = IntegralMath.mulDivF(x, q + FIXED_1, q + p);
        else:
            p = AnalyticMath.fixedLog(x);
            q = IntegralMath.mulShrF(p, p, SCALE_1);
            y = IntegralMath.mulDivF(FIXED_1, q + FIXED_1, p + FIXED_1);
        for i in range(7):
            e = AnalyticMath.fixedExp(y);
            f = IntegralMath.mulShrF(y, e, SCALE_1);
            g = IntegralMath.mulShrF(y, f, SCALE_1);
            y = IntegralMath.mulDivF(FIXED_1, g + x, f + e);
        return IntegralMath.mulDivF(FIXED_1, y, x);
    return lambertPos3(x);

'''
    @dev Compute W(-x / FIXED_1) / (-x / FIXED_1) * FIXED_1
    Input range: 1 <= x <= LAMBERT_NEG2_MAXVAL
'''
def lambertNegQuick(x):
    require(x > 0, "lambertNegQuick: x < min");
    if (x <= LAMBERT_NEG1_MAXVAL):
        return lambertNeg1(x);
    if (x <= LAMBERT_NEG2_MAXVAL):
        return lambertNeg2(x);
    revert("lambertNegQuick: x > max");

'''
    @dev Compute W(x / FIXED_1) / (x / FIXED_1) * FIXED_1
    Input range: 1 <= x <= 2 ^ 256 - 1
'''
def lambertPosQuick(x):
    require(x > 0, "lambertPosQuick: x < min");
    if (x <= LAMBERT_POS1_MAXVAL):
        return lambertPos1(x);
    if (x <= LAMBERT_POS2_MAXVAL):
        return lambertPos2(x);
    return lambertPos3(x);

'''
    @dev Compute W(-x / FIXED_1) / (-x / FIXED_1) * FIXED_1
    Input range: 1 <= x <= LAMBERT_NEG1_MAXVAL
    Auto-generated via 'PrintAdvancedMathLambertNeg1.py'
'''
def lambertNeg1(x):
    res = 0;
    xi = x;

    xi = xi * x >> SCALE_1; res += xi * 0x00000000014d29a73a6e7b02c3668c7b0880000000; # add x^(03-1) * (34! * 03^(03-1) / 03!)
    xi = xi * x >> SCALE_1; res += xi * 0x0000000002504a0cd9a7f7215b60f9be4800000000; # add x^(04-1) * (34! * 04^(04-1) / 04!)
    xi = xi * x >> SCALE_1; res += xi * 0x000000000484d0a1191c0ead267967c7a4a0000000; # add x^(05-1) * (34! * 05^(05-1) / 05!)
    xi = xi * x >> SCALE_1; res += xi * 0x00000000095ec580d7e8427a4baf26a90a00000000; # add x^(06-1) * (34! * 06^(06-1) / 06!)
    xi = xi * x >> SCALE_1; res += xi * 0x000000001440b0be1615a47dba6e5b3b1f10000000; # add x^(07-1) * (34! * 07^(07-1) / 07!)
    xi = xi * x >> SCALE_1; res += xi * 0x000000002d207601f46a99b4112418400000000000; # add x^(08-1) * (34! * 08^(08-1) / 08!)
    xi = xi * x >> SCALE_1; res += xi * 0x0000000066ebaac4c37c622dd8288a7eb1b2000000; # add x^(09-1) * (34! * 09^(09-1) / 09!)
    xi = xi * x >> SCALE_1; res += xi * 0x00000000ef17240135f7dbd43a1ba10cf200000000; # add x^(10-1) * (34! * 10^(10-1) / 10!)
    xi = xi * x >> SCALE_1; res += xi * 0x0000000233c33c676a5eb2416094a87b3657000000; # add x^(11-1) * (34! * 11^(11-1) / 11!)
    xi = xi * x >> SCALE_1; res += xi * 0x0000000541cde48bc0254bed49a9f8700000000000; # add x^(12-1) * (34! * 12^(12-1) / 12!)
    xi = xi * x >> SCALE_1; res += xi * 0x0000000cae1fad2cdd4d4cb8d73abca0d19a400000; # add x^(13-1) * (34! * 13^(13-1) / 13!)
    xi = xi * x >> SCALE_1; res += xi * 0x0000001edb2aa2f760d15c41ceedba956400000000; # add x^(14-1) * (34! * 14^(14-1) / 14!)
    xi = xi * x >> SCALE_1; res += xi * 0x0000004ba8d20d2dabd386c9529659841a2e200000; # add x^(15-1) * (34! * 15^(15-1) / 15!)
    xi = xi * x >> SCALE_1; res += xi * 0x000000bac08546b867cdaa20000000000000000000; # add x^(16-1) * (34! * 16^(16-1) / 16!)
    xi = xi * x >> SCALE_1; res += xi * 0x000001cfa8e70c03625b9db76c8ebf5bbf24820000; # add x^(17-1) * (34! * 17^(17-1) / 17!)
    xi = xi * x >> SCALE_1; res += xi * 0x000004851d99f82060df265f3309b26f8200000000; # add x^(18-1) * (34! * 18^(18-1) / 18!)
    xi = xi * x >> SCALE_1; res += xi * 0x00000b550d19b129d270c44f6f55f027723cbb0000; # add x^(19-1) * (34! * 19^(19-1) / 19!)
    xi = xi * x >> SCALE_1; res += xi * 0x00001c877dadc761dc272deb65d4b0000000000000; # add x^(20-1) * (34! * 20^(20-1) / 20!)
    xi = xi * x >> SCALE_1; res += xi * 0x000048178ece97479f33a77f2ad22a81b64406c000; # add x^(21-1) * (34! * 21^(21-1) / 21!)
    xi = xi * x >> SCALE_1; res += xi * 0x0000b6ca8268b9d810fedf6695ef2f8a6c00000000; # add x^(22-1) * (34! * 22^(22-1) / 22!)
    xi = xi * x >> SCALE_1; res += xi * 0x0001d0e76631a5b05d007b8cb72a7c7f11ec36e000; # add x^(23-1) * (34! * 23^(23-1) / 23!)
    xi = xi * x >> SCALE_1; res += xi * 0x0004a1c37bd9f85fd9c6c780000000000000000000; # add x^(24-1) * (34! * 24^(24-1) / 24!)
    xi = xi * x >> SCALE_1; res += xi * 0x000bd8369f1b702bf491e2ebfcee08250313b65400; # add x^(25-1) * (34! * 25^(25-1) / 25!)
    xi = xi * x >> SCALE_1; res += xi * 0x001e5c7c32a9f6c70ab2cb59d9225764d400000000; # add x^(26-1) * (34! * 26^(26-1) / 26!)
    xi = xi * x >> SCALE_1; res += xi * 0x004dff5820e165e910f95120a708e742496221e600; # add x^(27-1) * (34! * 27^(27-1) / 27!)
    xi = xi * x >> SCALE_1; res += xi * 0x00c8c8f66db1fced378ee50e536000000000000000; # add x^(28-1) * (34! * 28^(28-1) / 28!)
    xi = xi * x >> SCALE_1; res += xi * 0x0205db8dffff45bfa2938f128f599dbf16eb11d880; # add x^(29-1) * (34! * 29^(29-1) / 29!)
    xi = xi * x >> SCALE_1; res += xi * 0x053a044ebd984351493e1786af38d39a0800000000; # add x^(30-1) * (34! * 30^(30-1) / 30!)
    xi = xi * x >> SCALE_1; res += xi * 0x0d86dae2a4cc0f47633a544479735869b487b59c40; # add x^(31-1) * (34! * 31^(31-1) / 31!)
    xi = xi * x >> SCALE_1; res += xi * 0x231000000000000000000000000000000000000000; # add x^(32-1) * (34! * 32^(32-1) / 32!)
    xi = xi * x >> SCALE_1; res += xi * 0x5b0485a76f6646c2039db1507cdd51b08649680822; # add x^(33-1) * (34! * 33^(33-1) / 33!)
    xi = xi * x >> SCALE_1; res += xi * 0xec983c46c49545bc17efa6b5b0055e242200000000; # add x^(34-1) * (34! * 34^(34-1) / 34!)

    return res // 0xde1bc4d19efcac82445da75b00000000 + FIXED_1 + x; # divide by 34! and then add x^(1-1) * (1^(1-1) / 1!) + x^(2-1) * (2^(2-1) / 2!)

'''
    @dev Compute W(x / FIXED_1) / (x / FIXED_1) * FIXED_1
    Input range: 1 <= x <= LAMBERT_POS1_MAXVAL
    Auto-generated via 'PrintAdvancedMathLambertPos1.py'
'''
def lambertPos1(x):
    res = 0;
    xi = x;

    xi = xi * x >> SCALE_1; res += xi * 0x00000000014d29a73a6e7b02c3668c7b0880000000; # add x^(03-1) * (34! * 03^(03-1) / 03!)
    xi = xi * x >> SCALE_1; res -= xi * 0x0000000002504a0cd9a7f7215b60f9be4800000000; # sub x^(04-1) * (34! * 04^(04-1) / 04!)
    xi = xi * x >> SCALE_1; res += xi * 0x000000000484d0a1191c0ead267967c7a4a0000000; # add x^(05-1) * (34! * 05^(05-1) / 05!)
    xi = xi * x >> SCALE_1; res -= xi * 0x00000000095ec580d7e8427a4baf26a90a00000000; # sub x^(06-1) * (34! * 06^(06-1) / 06!)
    xi = xi * x >> SCALE_1; res += xi * 0x000000001440b0be1615a47dba6e5b3b1f10000000; # add x^(07-1) * (34! * 07^(07-1) / 07!)
    xi = xi * x >> SCALE_1; res -= xi * 0x000000002d207601f46a99b4112418400000000000; # sub x^(08-1) * (34! * 08^(08-1) / 08!)
    xi = xi * x >> SCALE_1; res += xi * 0x0000000066ebaac4c37c622dd8288a7eb1b2000000; # add x^(09-1) * (34! * 09^(09-1) / 09!)
    xi = xi * x >> SCALE_1; res -= xi * 0x00000000ef17240135f7dbd43a1ba10cf200000000; # sub x^(10-1) * (34! * 10^(10-1) / 10!)
    xi = xi * x >> SCALE_1; res += xi * 0x0000000233c33c676a5eb2416094a87b3657000000; # add x^(11-1) * (34! * 11^(11-1) / 11!)
    xi = xi * x >> SCALE_1; res -= xi * 0x0000000541cde48bc0254bed49a9f8700000000000; # sub x^(12-1) * (34! * 12^(12-1) / 12!)
    xi = xi * x >> SCALE_1; res += xi * 0x0000000cae1fad2cdd4d4cb8d73abca0d19a400000; # add x^(13-1) * (34! * 13^(13-1) / 13!)
    xi = xi * x >> SCALE_1; res -= xi * 0x0000001edb2aa2f760d15c41ceedba956400000000; # sub x^(14-1) * (34! * 14^(14-1) / 14!)
    xi = xi * x >> SCALE_1; res += xi * 0x0000004ba8d20d2dabd386c9529659841a2e200000; # add x^(15-1) * (34! * 15^(15-1) / 15!)
    xi = xi * x >> SCALE_1; res -= xi * 0x000000bac08546b867cdaa20000000000000000000; # sub x^(16-1) * (34! * 16^(16-1) / 16!)
    xi = xi * x >> SCALE_1; res += xi * 0x000001cfa8e70c03625b9db76c8ebf5bbf24820000; # add x^(17-1) * (34! * 17^(17-1) / 17!)
    xi = xi * x >> SCALE_1; res -= xi * 0x000004851d99f82060df265f3309b26f8200000000; # sub x^(18-1) * (34! * 18^(18-1) / 18!)
    xi = xi * x >> SCALE_1; res += xi * 0x00000b550d19b129d270c44f6f55f027723cbb0000; # add x^(19-1) * (34! * 19^(19-1) / 19!)
    xi = xi * x >> SCALE_1; res -= xi * 0x00001c877dadc761dc272deb65d4b0000000000000; # sub x^(20-1) * (34! * 20^(20-1) / 20!)
    xi = xi * x >> SCALE_1; res += xi * 0x000048178ece97479f33a77f2ad22a81b64406c000; # add x^(21-1) * (34! * 21^(21-1) / 21!)
    xi = xi * x >> SCALE_1; res -= xi * 0x0000b6ca8268b9d810fedf6695ef2f8a6c00000000; # sub x^(22-1) * (34! * 22^(22-1) / 22!)
    xi = xi * x >> SCALE_1; res += xi * 0x0001d0e76631a5b05d007b8cb72a7c7f11ec36e000; # add x^(23-1) * (34! * 23^(23-1) / 23!)
    xi = xi * x >> SCALE_1; res -= xi * 0x0004a1c37bd9f85fd9c6c780000000000000000000; # sub x^(24-1) * (34! * 24^(24-1) / 24!)
    xi = xi * x >> SCALE_1; res += xi * 0x000bd8369f1b702bf491e2ebfcee08250313b65400; # add x^(25-1) * (34! * 25^(25-1) / 25!)
    xi = xi * x >> SCALE_1; res -= xi * 0x001e5c7c32a9f6c70ab2cb59d9225764d400000000; # sub x^(26-1) * (34! * 26^(26-1) / 26!)
    xi = xi * x >> SCALE_1; res += xi * 0x004dff5820e165e910f95120a708e742496221e600; # add x^(27-1) * (34! * 27^(27-1) / 27!)
    xi = xi * x >> SCALE_1; res -= xi * 0x00c8c8f66db1fced378ee50e536000000000000000; # sub x^(28-1) * (34! * 28^(28-1) / 28!)
    xi = xi * x >> SCALE_1; res += xi * 0x0205db8dffff45bfa2938f128f599dbf16eb11d880; # add x^(29-1) * (34! * 29^(29-1) / 29!)
    xi = xi * x >> SCALE_1; res -= xi * 0x053a044ebd984351493e1786af38d39a0800000000; # sub x^(30-1) * (34! * 30^(30-1) / 30!)
    xi = xi * x >> SCALE_1; res += xi * 0x0d86dae2a4cc0f47633a544479735869b487b59c40; # add x^(31-1) * (34! * 31^(31-1) / 31!)
    xi = xi * x >> SCALE_1; res -= xi * 0x231000000000000000000000000000000000000000; # sub x^(32-1) * (34! * 32^(32-1) / 32!)
    xi = xi * x >> SCALE_1; res += xi * 0x5b0485a76f6646c2039db1507cdd51b08649680822; # add x^(33-1) * (34! * 33^(33-1) / 33!)
    xi = xi * x >> SCALE_1; res -= xi * 0xec983c46c49545bc17efa6b5b0055e242200000000; # sub x^(34-1) * (34! * 34^(34-1) / 34!)

    return res // 0xde1bc4d19efcac82445da75b00000000 + FIXED_1 - x; # divide by 34! and then add x^(1-1) * (1^(1-1) / 1!) - x^(2-1) * (2^(2-1) / 2!)

'''
    @dev Compute W(-x / FIXED_1) / (-x / FIXED_1) * FIXED_1
    Input range: LAMBERT_NEG1_MAXVAL + 1 <= x <= LAMBERT_NEG2_MAXVAL
'''
def lambertNeg2(x):
    values = LAMBERT_NEG2_VALUES;
    y = x - LAMBERT_NEG1_MAXVAL - 1;
    i = y // LAMBERT_NEG2_SAMPLE;
    a = LAMBERT_NEG2_SAMPLE * (i + 0);
    b = LAMBERT_NEG2_SAMPLE * (i + 1);
    c = LAMBERT_NEG2_T_SIZE * (i + 1);
    d = LAMBERT_NEG2_T_SIZE * (i + 2);
    e = read(values, c) & LAMBERT_NEG2_T_MASK;
    f = read(values, d) & LAMBERT_NEG2_T_MASK;
    g = e * (b - y);
    h = f * (y - a);
    return (g + h) // LAMBERT_NEG2_SAMPLE;

'''
    @dev Compute W(x / FIXED_1) / (x / FIXED_1) * FIXED_1
    Input range: LAMBERT_POS1_MAXVAL + 1 <= x <= LAMBERT_POS2_MAXVAL
'''
def lambertPos2(x):
    values = LAMBERT_POS2_VALUES;
    y = x - LAMBERT_POS1_MAXVAL - 1;
    i = y // LAMBERT_POS2_SAMPLE;
    a = LAMBERT_POS2_SAMPLE * (i + 0);
    b = LAMBERT_POS2_SAMPLE * (i + 1);
    c = LAMBERT_POS2_T_SIZE * (i + 1);
    d = LAMBERT_POS2_T_SIZE * (i + 2);
    e = read(values, c) & LAMBERT_POS2_T_MASK;
    f = read(values, d) & LAMBERT_POS2_T_MASK;
    g = e * (b - y);
    h = f * (y - a);
    return (g + h) // LAMBERT_POS2_SAMPLE;

'''
    @dev Compute W(x / FIXED_1) / (x / FIXED_1) * FIXED_1
    Input range: LAMBERT_POS2_MAXVAL + 1 <= x <= 2 ^ 256 - 1
'''
def lambertPos3(x):
    a = AnalyticMath.fixedLog(x);
    b = AnalyticMath.fixedLog(a);
    c = IntegralMath.mulShrF(a, a * 2, SCALE_1);
    d = IntegralMath.mulDivF(b, b + (a - FIXED_1) * 2, c);
    e = IntegralMath.mulDivF(FIXED_1, a - b + d, x);
    return e;

'''
    @dev Solve the equation x * (a / b) ^ x = c / d for x
'''
def solve(a, b, c, d, lambertNeg, lambertPos):
    if (a > b):
        return call(lambertPos, a, b, c, d);
    if (b > a):
        return call(lambertNeg, b, a, c, d);
    return (c, d);

'''
    @dev Return f(log(x / y) * z / w * FIXED_1) * z / w / FIXED_1
'''
def call(f, x, y, z, w):
    return FractionMath.productRatio(
        f(
            IntegralMath.mulDivF(
                AnalyticMath.fixedLog(
                    IntegralMath.mulDivF(
                        FIXED_1, x, y
                    )
                ), z, w
            )
        ), z, w, FIXED_1
    );

'''
    @dev Read 32 bytes from a given chunk of data at a given offset
'''
def read(data, offset):
    return int(("0" * 64 + data)[offset * 2 : offset * 2 + 64], 16);
